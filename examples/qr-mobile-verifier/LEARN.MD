# 🎓 LEARN.MD: QR 碼風控驗證外掛 (模擬 Gmail 機制)

## 🌟 專案簡介：為什麼要寫這個？
很多大型網站 (如 Google, Facebook) 在註冊時都會要求「手機驗證」，這不只是為了收集電話，更是為了**「阻擋惡意機器人」**與**「防止大量註冊 (洗帳號)」**。
這個專案讓你學習如何用 WordPress 實作這套機制。我們使用 **「全模擬模式」**，意味著你不需要花錢發簡訊，但能學到所有核心的程式邏輯。

---

## 🏗️ 核心架構：雙重鑰匙與守門員
想像這是一個需要兩個人同時轉動鑰匙才能開啟的保險箱：

### 1. 🔒 電腦端 (The Lock)
- **角色**：發起者。顯示 QR Code (題目)。
- **技術**：`Shortcode`
- **行為**：它不知道手機端發生了什麼事，所以它派了一個「偵察兵 (AJAX)」每隔幾秒去問伺服器：「開了嗎？」。

### 2. 🔑 手機端 (The Key)
- **角色**：解鎖者。掃描 QR Code，輸入簡訊碼 (答案)。
- **技術**：`Template Redirect`, `Risk Control`
- **行為**：這是駭客最想攻擊的地方，所以我們在這裡設下重重關卡 (風控)。

### 3. 🛡️ 守門員 (Risk Control)
- **角色**：風控中心。Google 最強大的這部分。
- **技術**：`Custom Database Table`
- **邏輯**：
    - **IP 限制**：同一個 IP，一天只能開鎖 5 次。
    - **裝置限制**：同一支手機號碼，一個月只能驗證 3 次。

---

## 🧠 技術深度解析

### A. 跨裝置通訊 (AJAX Polling)
電腦與手機是兩個完全不相連的裝置，它們如何溝通？
**答案：透過資料庫 (Transients)。**
1.  **電腦產生 Token** `abc1234`，存入資料庫，狀態設為 `pending`。
2.  電腦每 2 秒問一次伺服器：`check_status('abc1234')`。
3.  伺服器回答：`pending`。
4.  **手機掃碼**，進入網頁，輸入驗證碼。
5.  伺服器將資料庫中的 `abc1234` 狀態改為 `verified`。
6.  電腦再次詢問：`check_status('abc1234')`。
7.  伺服器回答：`verified`。
8.  **電腦解鎖成功！**

> **為什麼不用 WebSocket?**
> 對於這種簡單的驗證，AJAX 輪詢 (Pollling) 是最簡單、成本最低的實作方式，不需要額外的 Socket 伺服器。

### B. 風控演算法 (Risk Algorithm)
我們建立了一個專用的資料表 `wp_qrmv_history`。為什麼不用 WP 內建的 `post_meta`？
因為 SQL 效能！我們需要做這樣的查詢：
```sql
SELECT COUNT(*) FROM history 
WHERE ip = '1.2.3.4' AND time > 24_hours_ago
```
如果資料量大，使用專用表格加上適當的 `INDEX` (我們對 `ip` 和 `phone` 做了索引)，速度會快上百倍。

---

## 🚀 未來挑戰 (給你的作業)
1.  **真實簡訊**：試著申請 Twilio API，把 `mobile-verify.php` 裡的模擬簡訊換成真簡訊。
2.  **更強的指紋**：現在我們只記錄 User Agent。試著整合 `FingerprintJS` 來識別更精確的裝置。
3.  **防止 CSRF**：在 AJAX 請求中加入 Nonce 驗證，確保請求真的來自你的網站。

---
**Happy Coding!** 希望這個專案能讓你對「風控」與「前後端分離通訊」有更深的理解。
