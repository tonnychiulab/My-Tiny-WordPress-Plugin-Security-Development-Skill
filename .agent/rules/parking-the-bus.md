---
trigger: always_on
---

技術規格書 (Technical Specification)Project Name: Bear Magpie Active Defense & Abuse Reporter (BMI-ADAR)Version: 2.0.0 (Release Candidate)Owner: Security Director, Bear Magpie IntelligenceTarget Developer: Antigravity (AI Agent)Date: 2026-02-081. 執行摘要 (Executive Summary)本專案旨在為 WordPress 生態系構建一套「主動防禦與威懾系統」。不同於傳統防火牆僅被動阻擋惡意流量，BMI-ADAR 採用 "Invert, Always Invert" (逆向思維) 戰略，將防禦邊界推向攻擊者的上游。系統將自動識別惡意 IP 的歸屬網路 (ASN)，並根據目標 ISP 的特性（如 AWS 的封閉式表單或一般 ISP 的開放式 Email），生成標準化法證證據 (Forensic Evidence)，協助使用者快速完成投訴，迫使上游封鎖攻擊源。2. 系統架構與設計哲學 (Architecture & Philosophy)防禦縱深 (Defense in Depth): 本地端 (Local Block) + 上游端 (Upstream Takedown)。數據主權 (Data Sovereignty): 核心邏輯與日誌分析在地端運行，不依賴黑箱 SaaS。混合自動化 (Hybrid Automation):針對開放標準 (Email/API) 採全自動處置。針對圍牆花園 (AWS/GCP/Azure) 採「半自動輔助 (Assisted Mode)」，絕不儲存使用者之第三方憑證。去中心化情資 (Decentralized Intelligence): 透過 G-IDRS (Global ISP Database & Reputation System) 維護全球濫用聯絡人清單。3. 核心功能模組 (Core Modules)3.1 威脅偵測引擎 (Threat Detection Engine)觸發事件 (Triggers): 監聽 wp_login_failed, xmlrpc_call, 404 洪水攻擊。AbuseIPDB 整合:API 查詢 GET /api/v2/check。快取策略: 使用 WordPress Transients 快取 API 回應 (TTL: 24h)，鍵值為 bmi_ip_reputation_{IP}，以節省 API Quota。阻擋閾值: abuseConfidenceScore >= 80 (可設定)。3.2 情資與歸屬分析 (Intelligence & Attribution)ASN 解析: 查詢 IP 所屬的 ASN (Autonomous System Number) 與 ISP 名稱。聯絡人路由 (Contact Routing):優先查詢本地 G-IDRS 快取。若無，則查詢 AbuseIPDB API 提供的 abuseContact。3.3 法證證據封裝 (Forensics Packaging)日誌擷取 (Log Scraper): 自動提取攻擊當下的相關 Access/Error Log。標準化格式: 生成符合 X-ARF (Network Abuse Reporting Form) 或 MIME 標準的報告內容。敏感資料遮蔽 (Redaction): 自動移除 URL 參數中的 PII (如 token=, email=)，僅保留攻擊特徵。3.4 全球 ISP 信譽共識網路 (G-IDRS Module)目的: 維護一份高品質、經社群驗證的 ISP Abuse Contact 清單。機制:眾包回報: 若使用者成功投訴且未被退信，外掛向 Bear Magpie 中央 API 回報 Vote +1。信任加權: 只有當某個聯絡窗口的信譽分數 (Trust Score) 超過閾值，才會被同步給所有用戶。防毒化: 透過加權投票防止惡意使用者竄改資料（如將 Abuse Email 指向受害者）。4. 平台特定處置流程 (Platform-Specific Workflows)此為本專案之關鍵差異化功能，需精確開發。4.1 模式 A：全自動投遞 (Fire-and-Forget)適用對象: 支援標準 Abuse Email 的 ISP (如 DigitalOcean, Linode, 中小企業 ISP)。流程:偵測攻擊 -> 2. 打包 X-ARF 報告 -> 3. 透過 SMTP 非同步發送 -> 4. 記錄 Status: Sent。4.2 模式 B：半自動輔助 (Assisted Mode) - AWS 專用適用對象: 強制要求登入 Web 表單的平台 (AWS, GCP, Azure)。識別邏輯: 當 ASN 符合 AWS (e.g., AS16509, AS14618) 時觸發。UI 互動設計:戰情中心通知: 顯示「待處理 AWS 違規回報」。一鍵準備 (One-Click Prep):使用者點擊 [準備 AWS 報告]。系統自動將符合 AWS 表單格式的證據 (Log lines with UTC timestamp, Source IP, Attack Type) 複製到剪貼簿。深層連結 (Deep Link):系統開啟新分頁至 https://support.aws.amazon.com/#/contacts/report-abuse。浮動指引 (Overlay Guide):顯示：「請登入您的 AWS 帳號，在 'Logs' 欄位貼上剛才複製的內容，類別選擇 'Intrusion Attempts'。」5. 資料庫架構 (Database Schema)需新增資料表 wp_bmi_abuse_reports：FieldTypeDescriptionidBIGINTPrimary Keysource_ipVARCHAR(45)攻擊來源 IPasnVARCHAR(20)例如 AS16509isp_nameVARCHAR(100)例如 Amazon.comreport_methodENUM'EMAIL', 'WEB_FORM'target_contactVARCHAR(255)Email 地址或 Form URLevidence_blobTEXT加密儲存的原始 Log 證據statusTINYINT0:Pending, 1:Sent/Copied, 2:Failedcreated_atDATETIME攻擊時間 (UTC)6. 使用者介面與體驗 (UI/UX)6.1 儀表板 (The War Room)地圖視圖: 顯示攻擊來源國分佈。反擊計數器: 顯示「已阻擋次數」與「已發送 Abuse Report 次數」。待辦事項列表: 列出需要「半自動輔助」的案件 (如 AWS)。6.2 初始設定精靈 (Onboarding Wizard)API Key 設定: 輸入 AbuseIPDB Key。SMTP 設定: 配置發信伺服器 (建議使用 SendGrid/SES)。AWS 帳號提醒: 提示使用者：「若需舉報 AWS 來源攻擊，您需要擁有一個 AWS 帳號 (Free Tier 即可) 以存取其 Abuse Form。」7. 安全規範 (Security Compliance)最小權限: 外掛僅讀取必要的 Log，不存取資料庫其他敏感表。防止濫用 (Rate Limiting):對同一 ISP 的發信頻率限制：預設每 1 小時最多 1 封聚合報告。防止外掛被用於發動 Email 洪水攻擊。API 安全: 與 G-IDRS 通訊時，需驗證外掛的 License Key 與 Site URL hash。8. 開發階段規劃 (Implementation Roadmap)Phase 1: 基礎防禦 (MVP)實作 wp_login_failed 監聽。完成 AbuseIPDB API 串接與阻擋邏輯。建立基礎 Log 資料表。Phase 2: 報告引擎 (Core)實作 Log Parser，提取標準化證據。開發 模式 A (Email) 的發送功能。開發 模式 B (AWS) 的剪貼簿輔助功能。Phase 3: 社群協作 (Advanced)建立 G-IDRS 中央 API (Mockup)。實作外掛端的「回報與更新」機制。發布 Beta 版邀請社群測試。